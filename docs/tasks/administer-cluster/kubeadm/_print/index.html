<!doctype html><html lang=en class=no-js><head><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36037335-10"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-36037335-10')</script><link rel=alternate hreflang=zh href=https://kubernetes.io/zh/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=fr href=https://kubernetes.io/fr/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=de href=https://kubernetes.io/de/docs/tasks/administer-cluster/kubeadm/><link rel=alternate hreflang=es href=https://kubernetes.io/es/docs/tasks/administer-cluster/kubeadm/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.82.0"><link rel=canonical type=text/html href=https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>Administration with kubeadm | Kubernetes</title><meta property="og:title" content="Administration with kubeadm"><meta property="og:description" content="Production-Grade Container Orchestration"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="Administration with kubeadm"><meta itemprop=description content="Production-Grade Container Orchestration"><meta name=twitter:card content="summary"><meta name=twitter:title content="Administration with kubeadm"><meta name=twitter:description content="Production-Grade Container Orchestration"><link rel=preload href=/scss/main.min.aeea2a074ae7ac3d467a0d6f52e45894b49452cbb3f0f410c268ec7280c5a653.css as=style><link href=/scss/main.min.aeea2a074ae7ac3d467a0d6f52e45894b49452cbb3f0f410c268ec7280c5a653.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png"}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content><meta property="og:description" content><meta name=twitter:description content><meta property="og:url" content="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/"><meta property="og:title" content="Administration with kubeadm"><meta name=twitter:title content="Administration with kubeadm"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:image" content="/images/kubernetes-horizontal-color.png"><meta property="og:type" content="article"><script src=/js/script.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/docs/>Documentation</span></a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/blog/>Kubernetes Blog</span></a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/training/>Training</span></a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/partners/>Partners</span></a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/community/>Community</span></a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/case-studies/>Case Studies</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Versions</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/>v1.23</a>
<a class=dropdown-item href=https://v1-22.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/>v1.22</a>
<a class=dropdown-item href=https://v1-21.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/>v1.21</a>
<a class=dropdown-item href=https://v1-20.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/>v1.20</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/tasks/administer-cluster/kubeadm/>中文 Chinese</a>
<a class=dropdown-item href=/ko/docs/tasks/administer-cluster/kubeadm/>한국어 Korean</a>
<a class=dropdown-item href=/fr/docs/tasks/administer-cluster/kubeadm/>Français</a>
<a class=dropdown-item href=/de/docs/tasks/administer-cluster/kubeadm/>Deutsch</a>
<a class=dropdown-item href=/es/docs/tasks/administer-cluster/kubeadm/>Español</a></div></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/tasks/administer-cluster/kubeadm/>Return to the regular view of this page</a>.</p></div><h1 class=title>Administration with kubeadm</h1><ul><li>1: <a href=#pg-f62fba1de4084f3be070785757c8079c>Certificate Management with kubeadm</a></li><li>2: <a href=#pg-2e173356df5179cab9eec90a606f0aa4>Upgrading kubeadm clusters</a></li><li>3: <a href=#pg-9133578f1e75663bb031e5a377ca896d>Adding Windows nodes</a></li><li>4: <a href=#pg-e805c7d8d4ad6195cb82dbbc843bfc29>Upgrading Windows nodes</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-f62fba1de4084f3be070785757c8079c>1 - Certificate Management with kubeadm</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.15 [stable]</code></div><p>Client certificates generated by <a href=/docs/reference/setup-tools/kubeadm/>kubeadm</a> expire after 1 year. This page explains how to manage certificate renewals with kubeadm.</p><h2 id=before-you-begin>Before you begin</h2><p>You should be familiar with <a href=/docs/setup/best-practices/certificates/>PKI certificates and requirements in Kubernetes</a>.</p><h2 id=custom-certificates>Using custom certificates</h2><p>By default, kubeadm generates all the certificates needed for a cluster to run.
You can override this behavior by providing your own certificates.</p><p>To do so, you must place them in whatever directory is specified by the
<code>--cert-dir</code> flag or the <code>certificatesDir</code> field of kubeadm's <code>ClusterConfiguration</code>.
By default this is <code>/etc/kubernetes/pki</code>.</p><p>If a given certificate and private key pair exists before running <code>kubeadm init</code>,
kubeadm does not overwrite them. This means you can, for example, copy an existing
CA into <code>/etc/kubernetes/pki/ca.crt</code> and <code>/etc/kubernetes/pki/ca.key</code>,
and kubeadm will use this CA for signing the rest of the certificates.</p><h2 id=external-ca-mode>External CA mode</h2><p>It is also possible to provide only the <code>ca.crt</code> file and not the
<code>ca.key</code> file (this is only available for the root CA file, not other cert pairs).
If all other certificates and kubeconfig files are in place, kubeadm recognizes
this condition and activates the "External CA" mode. kubeadm will proceed without the
CA key on disk.</p><p>Instead, run the controller-manager standalone with <code>--controllers=csrsigner</code> and
point to the CA certificate and key.</p><p><a href=/docs/setup/best-practices/certificates/>PKI certificates and requirements</a> includes guidance on
setting up a cluster to use an external CA.</p><h2 id=check-certificate-expiration>Check certificate expiration</h2><p>You can use the <code>check-expiration</code> subcommand to check when certificates expire:</p><pre><code>kubeadm certs check-expiration
</code></pre><p>The output is similar to this:</p><pre><code>CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 30, 2020 23:36 UTC   364d                                    no
apiserver                  Dec 30, 2020 23:36 UTC   364d            ca                      no
apiserver-etcd-client      Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Dec 30, 2020 23:36 UTC   364d            ca                      no
controller-manager.conf    Dec 30, 2020 23:36 UTC   364d                                    no
etcd-healthcheck-client    Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-peer                  Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-server                Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
front-proxy-client         Dec 30, 2020 23:36 UTC   364d            front-proxy-ca          no
scheduler.conf             Dec 30, 2020 23:36 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Dec 28, 2029 23:36 UTC   9y              no
etcd-ca                 Dec 28, 2029 23:36 UTC   9y              no
front-proxy-ca          Dec 28, 2029 23:36 UTC   9y              no
</code></pre><p>The command shows expiration/residual time for the client certificates in the <code>/etc/kubernetes/pki</code> folder and for the client certificate embedded in the KUBECONFIG files used by kubeadm (<code>admin.conf</code>, <code>controller-manager.conf</code> and <code>scheduler.conf</code>).</p><p>Additionally, kubeadm informs the user if the certificate is externally managed; in this case, the user should take care of managing certificate renewal manually/using other tools.</p><blockquote class="warning callout"><div><strong>Warning:</strong> <code>kubeadm</code> cannot manage certificates signed by an external CA.</div></blockquote><blockquote class="note callout"><div><strong>Note:</strong> <code>kubelet.conf</code> is not included in the list above because kubeadm configures kubelet for automatic certificate renewal.</div></blockquote><blockquote class="warning callout"><div><strong>Warning:</strong><p>On nodes created with <code>kubeadm init</code>, prior to kubeadm version 1.17, there is a
<a href=https://github.com/kubernetes/kubeadm/issues/1753>bug</a> where you manually have to modify the contents of <code>kubelet.conf</code>. After <code>kubeadm init</code> finishes, you should update <code>kubelet.conf</code> to point to the
rotated kubelet client certificates, by replacing <code>client-certificate-data</code> and <code>client-key-data</code> with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>client-certificate</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>client-key</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span></code></pre></div></div></blockquote><h2 id=automatic-certificate-renewal>Automatic certificate renewal</h2><p>kubeadm renews all the certificates during control plane <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>upgrade</a>.</p><p>This feature is designed for addressing the simplest use cases;
if you don't have specific requirements on certificate renewal and perform Kubernetes version upgrades regularly (less than 1 year in between each upgrade), kubeadm will take care of keeping your cluster up to date and reasonably secure.</p><blockquote class="note callout"><div><strong>Note:</strong> It is a best practice to upgrade your cluster frequently in order to stay secure.</div></blockquote><p>If you have more complex requirements for certificate renewal, you can opt out from the default behavior by passing <code>--certificate-renewal=false</code> to <code>kubeadm upgrade apply</code> or to <code>kubeadm upgrade node</code>.</p><blockquote class="warning callout"><div><strong>Warning:</strong> Prior to kubeadm version 1.17 there is a <a href=https://github.com/kubernetes/kubeadm/issues/1818>bug</a>
where the default value for <code>--certificate-renewal</code> is <code>false</code> for the <code>kubeadm upgrade node</code>
command. In that case, you should explicitly set <code>--certificate-renewal=true</code>.</div></blockquote><h2 id=manual-certificate-renewal>Manual certificate renewal</h2><p>You can renew your certificates manually at any time with the <code>kubeadm certs renew</code> command.</p><p>This command performs the renewal using CA (or front-proxy-CA) certificate and key stored in <code>/etc/kubernetes/pki</code>.</p><blockquote class="warning callout"><div><strong>Warning:</strong> If you are running an HA cluster, this command needs to be executed on all the control-plane nodes.</div></blockquote><blockquote class="note callout"><div><strong>Note:</strong> <code>certs renew</code> uses the existing certificates as the authoritative source for attributes (Common Name, Organization, SAN, etc.) instead of the kubeadm-config ConfigMap. It is strongly recommended to keep them both in sync.</div></blockquote><p><code>kubeadm certs renew</code> provides the following options:</p><p>The Kubernetes certificates normally reach their expiration date after one year.</p><ul><li><p><code>--csr-only</code> can be used to renew certificates with an external CA by generating certificate signing requests (without actually renewing certificates in place); see next paragraph for more information.</p></li><li><p>It's also possible to renew a single certificate instead of all.</p></li></ul><h2 id=renew-certificates-with-the-kubernetes-certificates-api>Renew certificates with the Kubernetes certificates API</h2><p>This section provide more details about how to execute manual certificate renewal using the Kubernetes certificates API.</p><blockquote class="caution callout"><div><strong>Caution:</strong> These are advanced topics for users who need to integrate their organization's certificate infrastructure into a kubeadm-built cluster. If the default kubeadm configuration satisfies your needs, you should let kubeadm manage certificates instead.</div></blockquote><h3 id=set-up-a-signer>Set up a signer</h3><p>The Kubernetes Certificate Authority does not work out of the box.
You can configure an external signer such as <a href=https://docs.cert-manager.io/en/latest/tasks/issuers/setup-ca.html>cert-manager</a>, or you can use the built-in signer.</p><p>The built-in signer is part of <a href=/docs/reference/command-line-tools-reference/kube-controller-manager/><code>kube-controller-manager</code></a>.</p><p>To activate the built-in signer, you must pass the <code>--cluster-signing-cert-file</code> and <code>--cluster-signing-key-file</code> flags.</p><p>If you're creating a new cluster, you can use a kubeadm <a href=https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2>configuration file</a>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta2<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerManager</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster-signing-cert-file</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/ca.crt<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster-signing-key-file</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/ca.key<span style=color:#bbb>
</span></code></pre></div><h3 id=create-certificate-signing-requests-csr>Create certificate signing requests (CSR)</h3><p>See <a href=/docs/reference/access-authn-authz/certificate-signing-requests/#create-certificatesigningrequest>Create CertificateSigningRequest</a> for creating CSRs with the Kubernetes API.</p><h2 id=renew-certificates-with-external-ca>Renew certificates with external CA</h2><p>This section provide more details about how to execute manual certificate renewal using an external CA.</p><p>To better integrate with external CAs, kubeadm can also produce certificate signing requests (CSRs).
A CSR represents a request to a CA for a signed certificate for a client.
In kubeadm terms, any certificate that would normally be signed by an on-disk CA can be produced as a CSR instead. A CA, however, cannot be produced as a CSR.</p><h3 id=create-certificate-signing-requests-csr-1>Create certificate signing requests (CSR)</h3><p>You can create certificate signing requests with <code>kubeadm certs renew --csr-only</code>.</p><p>Both the CSR and the accompanying private key are given in the output.
You can pass in a directory with <code>--csr-dir</code> to output the CSRs to the specified location.
If <code>--csr-dir</code> is not specified, the default certificate directory (<code>/etc/kubernetes/pki</code>) is used.</p><p>Certificates can be renewed with <code>kubeadm certs renew --csr-only</code>.
As with <code>kubeadm init</code>, an output directory can be specified with the <code>--csr-dir</code> flag.</p><p>A CSR contains a certificate's name, domains, and IPs, but it does not specify usages.
It is the responsibility of the CA to specify <a href=/docs/setup/best-practices/certificates/#all-certificates>the correct cert usages</a>
when issuing a certificate.</p><ul><li>In <code>openssl</code> this is done with the
<a href=https://superuser.com/questions/738612/openssl-ca-keyusage-extension><code>openssl ca</code> command</a>.</li><li>In <code>cfssl</code> you specify
<a href=https://github.com/cloudflare/cfssl/blob/master/doc/cmd/cfssl.txt#L170>usages in the config file</a>.</li></ul><p>After a certificate is signed using your preferred method, the certificate and the private key must be copied to the PKI directory (by default <code>/etc/kubernetes/pki</code>).</p><h2 id=certificate-authority-rotation>Certificate authority (CA) rotation</h2><p>Kubeadm does not support rotation or replacement of CA certificates out of the box.</p><p>For more information about manual rotation or replacement of CA, see <a href=/docs/tasks/tls/manual-rotation-of-ca-certificates/>manual rotation of CA certificates</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2e173356df5179cab9eec90a606f0aa4>2 - Upgrading kubeadm clusters</h1><p>This page explains how to upgrade a Kubernetes cluster created with kubeadm from version
1.19.x to version 1.20.x, and from version
1.20.x to 1.20.y (where <code>y > x</code>). Skipping MINOR versions
when upgrading is unsupported.</p><p>To see information about upgrading clusters created using older versions of kubeadm,
please refer to following pages instead:</p><ul><li><a href=https://v1-19.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.18 to 1.19</a></li><li><a href=https://v1-18.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.17 to 1.18</a></li><li><a href=https://v1-17.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.16 to 1.17</a></li><li><a href=https://v1-16.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading a kubeadm cluster from 1.15 to 1.16</a></li></ul><p>The upgrade workflow at high level is the following:</p><ol><li>Upgrade a primary control plane node.</li><li>Upgrade additional control plane nodes.</li><li>Upgrade worker nodes.</li></ol><h2 id=before-you-begin>Before you begin</h2><ul><li>Make sure you read the <a href=https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.24.md>release notes</a> carefully.</li><li>The cluster should use a static control plane and etcd pods or external etcd.</li><li>Make sure to back up any important components, such as app-level state stored in a database.
<code>kubeadm upgrade</code> does not touch your workloads, only components internal to Kubernetes, but backups are always a best practice.</li><li><a href=https://serverfault.com/questions/684771/best-way-to-disable-swap-in-linux>Swap must be disabled</a>.</li></ul><h3 id=additional-information>Additional information</h3><ul><li><a href=/docs/tasks/administer-cluster/safely-drain-node/>Draining nodes</a> before kubelet MINOR version
upgrades is required. In the case of control plane nodes, they could be running CoreDNS Pods or other critical workloads.</li><li>All containers are restarted after upgrade, because the container spec hash value is changed.</li></ul><h2 id=determine-which-version-to-upgrade-to>Determine which version to upgrade to</h2><p>Find the latest stable 1.20 version using the OS package manager:</p><ul class="nav nav-tabs" id=k8s-install-versions role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-versions-0 role=tab aria-controls=k8s-install-versions-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-versions-1 role=tab aria-controls=k8s-install-versions-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-versions><div id=k8s-install-versions-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-versions-0><p><pre><code>apt update
apt-cache madison kubeadm
# find the latest 1.20 version in the list
# it should look like 1.20.x-00, where x is the latest patch
</code></pre></div><div id=k8s-install-versions-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-versions-1><p><pre><code>yum list --showduplicates kubeadm --disableexcludes=kubernetes
# find the latest 1.20 version in the list
# it should look like 1.20.x-0, where x is the latest patch
</code></pre></div></div><h2 id=upgrading-control-plane-nodes>Upgrading control plane nodes</h2><p>The upgrade procedure on control plane nodes should be executed one node at a time.
Pick a control plane node that you wish to upgrade first. It must have the <code>/etc/kubernetes/admin.conf</code> file.</p><h3 id=call-kubeadm-upgrade>Call "kubeadm upgrade"</h3><p><strong>For the first control plane node</strong></p><ul><li>Upgrade kubeadm:</li></ul><ul class="nav nav-tabs" id=k8s-install-kubeadm-first-cp role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-kubeadm-first-cp-0 role=tab aria-controls=k8s-install-kubeadm-first-cp-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-kubeadm-first-cp-1 role=tab aria-controls=k8s-install-kubeadm-first-cp-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-kubeadm-first-cp><div id=k8s-install-kubeadm-first-cp-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-kubeadm-first-cp-0><p><pre><code># replace x in 1.20.x-00 with the latest patch version
apt-mark unhold kubeadm &amp;&amp; \
apt-get update &amp;&amp; apt-get install -y kubeadm=1.20.x-00 &amp;&amp; \
apt-mark hold kubeadm
-
# since apt-get version 1.1 you can also use the following method
apt-get update &amp;&amp; \
apt-get install -y --allow-change-held-packages kubeadm=1.20.x-00
</code></pre></div><div id=k8s-install-kubeadm-first-cp-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-kubeadm-first-cp-1><p><pre><code># replace x in 1.20.x-0 with the latest patch version
yum install -y kubeadm-1.20.x-0 --disableexcludes=kubernetes
</code></pre></div></div><ul><li><p>Verify that the download works and has the expected version:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubeadm version
</code></pre></div></li><li><p>Verify the upgrade plan:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubeadm upgrade plan
</code></pre></div><p>This command checks that your cluster can be upgraded, and fetches the versions you can upgrade to.
It also shows a table with the component config version states.</p></li></ul><blockquote class="note callout"><div><strong>Note:</strong> <code>kubeadm upgrade</code> also automatically renews the certificates that it manages on this node.
To opt-out of certificate renewal the flag <code>--certificate-renewal=false</code> can be used.
For more information see the <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-certs>certificate management guide</a>.</div></blockquote><blockquote class="note callout"><div><strong>Note:</strong> If <code>kubeadm upgrade plan</code> shows any component configs that require manual upgrade, users must provide
a config file with replacement configs to <code>kubeadm upgrade apply</code> via the <code>--config</code> command line flag.
Failing to do so will cause <code>kubeadm upgrade apply</code> to exit with an error and not perform an upgrade.</div></blockquote><ul><li><p>Choose a version to upgrade to, and run the appropriate command. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># replace x with the patch version you picked for this upgrade</span>
sudo kubeadm upgrade apply v1.20.x
</code></pre></div><p>Once the command finishes you should see:</p><pre><code>[upgrade/successful] SUCCESS! Your cluster was upgraded to &quot;v1.20.x&quot;. Enjoy!

[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.
</code></pre></li><li><p>Manually upgrade your CNI provider plugin.</p><p>Your Container Network Interface (CNI) provider may have its own upgrade instructions to follow.
Check the <a href=/docs/concepts/cluster-administration/addons/>addons</a> page to
find your CNI provider and see whether additional upgrade steps are required.</p><p>This step is not required on additional control plane nodes if the CNI provider runs as a DaemonSet.</p></li></ul><p><strong>For the other control plane nodes</strong></p><p>Same as the first control plane node but use:</p><pre><code>sudo kubeadm upgrade node
</code></pre><p>instead of:</p><pre><code>sudo kubeadm upgrade apply
</code></pre><p>Also calling <code>kubeadm upgrade plan</code> and upgrading the CNI provider plugin is no longer needed.</p><h3 id=drain-the-node>Drain the node</h3><ul><li><p>Prepare the node for maintenance by marking it unschedulable and evicting the workloads:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node you are draining</span>
kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</code></pre></div></li></ul><h3 id=upgrade-kubelet-and-kubectl>Upgrade kubelet and kubectl</h3><ul><li>Upgrade the kubelet and kubectl</li></ul><ul class="nav nav-tabs" id=k8s-install-kubelet role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-kubelet-0 role=tab aria-controls=k8s-install-kubelet-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-kubelet-1 role=tab aria-controls=k8s-install-kubelet-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-kubelet><div id=k8s-install-kubelet-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-kubelet-0><p><pre>
    # replace x in 1.20.x-00 with the latest patch version
    apt-mark unhold kubelet kubectl && \
    apt-get update && apt-get install -y kubelet=1.20.x-00 kubectl=1.20.x-00 && \
    apt-mark hold kubelet kubectl
    -
    # since apt-get version 1.1 you can also use the following method
    apt-get update && \
    apt-get install -y --allow-change-held-packages kubelet=1.20.x-00 kubectl=1.20.x-00
    </pre></div><div id=k8s-install-kubelet-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-kubelet-1><p><pre>
    # replace x in 1.20.x-0 with the latest patch version
    yum install -y kubelet-1.20.x-0 kubectl-1.20.x-0 --disableexcludes=kubernetes
    </pre></div></div><ul><li><p>Restart the kubelet:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo systemctl daemon-reload
sudo systemctl restart kubelet
</code></pre></div></li></ul><h3 id=uncordon-the-node>Uncordon the node</h3><ul><li><p>Bring the node back online by marking it schedulable:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node</span>
kubectl uncordon &lt;node-to-drain&gt;
</code></pre></div></li></ul><h2 id=upgrade-worker-nodes>Upgrade worker nodes</h2><p>The upgrade procedure on worker nodes should be executed one node at a time or few nodes at a time,
without compromising the minimum required capacity for running your workloads.</p><h3 id=upgrade-kubeadm>Upgrade kubeadm</h3><ul><li>Upgrade kubeadm:</li></ul><ul class="nav nav-tabs" id=k8s-install-kubeadm-worker-nodes role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-kubeadm-worker-nodes-0 role=tab aria-controls=k8s-install-kubeadm-worker-nodes-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-kubeadm-worker-nodes-1 role=tab aria-controls=k8s-install-kubeadm-worker-nodes-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-install-kubeadm-worker-nodes><div id=k8s-install-kubeadm-worker-nodes-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-kubeadm-worker-nodes-0><p><pre><code># replace x in 1.20.x-00 with the latest patch version
apt-mark unhold kubeadm &amp;&amp; \
apt-get update &amp;&amp; apt-get install -y kubeadm=1.20.x-00 &amp;&amp; \
apt-mark hold kubeadm
-
# since apt-get version 1.1 you can also use the following method
apt-get update &amp;&amp; \
apt-get install -y --allow-change-held-packages kubeadm=1.20.x-00
</code></pre></div><div id=k8s-install-kubeadm-worker-nodes-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-kubeadm-worker-nodes-1><p><pre><code># replace x in 1.20.x-0 with the latest patch version
yum install -y kubeadm-1.20.x-0 --disableexcludes=kubernetes
</code></pre></div></div><h3 id=call-kubeadm-upgrade-1>Call "kubeadm upgrade"</h3><ul><li><p>For worker nodes this upgrades the local kubelet configuration:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo kubeadm upgrade node
</code></pre></div></li></ul><h3 id=drain-the-node-1>Drain the node</h3><ul><li><p>Prepare the node for maintenance by marking it unschedulable and evicting the workloads:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node you are draining</span>
kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</code></pre></div></li></ul><h3 id=upgrade-kubelet-and-kubectl-1>Upgrade kubelet and kubectl</h3><ul><li>Upgrade the kubelet and kubectl:</li></ul><ul class="nav nav-tabs" id=k8s-kubelet-and-kubectl role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-kubelet-and-kubectl-0 role=tab aria-controls=k8s-kubelet-and-kubectl-0 aria-selected=true>Ubuntu, Debian or HypriotOS</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-kubelet-and-kubectl-1 role=tab aria-controls=k8s-kubelet-and-kubectl-1>CentOS, RHEL or Fedora</a></li></ul><div class=tab-content id=k8s-kubelet-and-kubectl><div id=k8s-kubelet-and-kubectl-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-kubelet-and-kubectl-0><p><pre><code># replace x in 1.20.x-00 with the latest patch version
apt-mark unhold kubelet kubectl &amp;&amp; \
apt-get update &amp;&amp; apt-get install -y kubelet=1.20.x-00 kubectl=1.20.x-00 &amp;&amp; \
apt-mark hold kubelet kubectl
-
# since apt-get version 1.1 you can also use the following method
apt-get update &amp;&amp; \
apt-get install -y --allow-change-held-packages kubelet=1.20.x-00 kubectl=1.20.x-00
</code></pre></div><div id=k8s-kubelet-and-kubectl-1 class=tab-pane role=tabpanel aria-labelledby=k8s-kubelet-and-kubectl-1><p><pre><code># replace x in 1.20.x-0 with the latest patch version
yum install -y kubelet-1.20.x-0 kubectl-1.20.x-0 --disableexcludes=kubernetes
</code></pre></div></div><ul><li><p>Restart the kubelet:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo systemctl daemon-reload
sudo systemctl restart kubelet
</code></pre></div></li></ul><h3 id=uncordon-the-node-1>Uncordon the node</h3><ul><li><p>Bring the node back online by marking it schedulable:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node</span>
kubectl uncordon &lt;node-to-drain&gt;
</code></pre></div></li></ul><h2 id=verify-the-status-of-the-cluster>Verify the status of the cluster</h2><p>After the kubelet is upgraded on all nodes verify that all nodes are available again by running the following command
from anywhere kubectl can access the cluster:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get nodes
</code></pre></div><p>The <code>STATUS</code> column should show <code>Ready</code> for all your nodes, and the version number should be updated.</p><h2 id=recovering-from-a-failure-state>Recovering from a failure state</h2><p>If <code>kubeadm upgrade</code> fails and does not roll back, for example because of an unexpected shutdown during execution, you can run <code>kubeadm upgrade</code> again.
This command is idempotent and eventually makes sure that the actual state is the desired state you declare.</p><p>To recover from a bad state, you can also run <code>kubeadm upgrade apply --force</code> without changing the version that your cluster is running.</p><p>During upgrade kubeadm writes the following backup folders under <code>/etc/kubernetes/tmp</code>:</p><ul><li><code>kubeadm-backup-etcd-&lt;date>-&lt;time></code></li><li><code>kubeadm-backup-manifests-&lt;date>-&lt;time></code></li></ul><p><code>kubeadm-backup-etcd</code> contains a backup of the local etcd member data for this control plane Node.
In case of an etcd upgrade failure and if the automatic rollback does not work, the contents of this folder
can be manually restored in <code>/var/lib/etcd</code>. In case external etcd is used this backup folder will be empty.</p><p><code>kubeadm-backup-manifests</code> contains a backup of the static Pod manifest files for this control plane Node.
In case of a upgrade failure and if the automatic rollback does not work, the contents of this folder can be
manually restored in <code>/etc/kubernetes/manifests</code>. If for some reason there is no difference between a pre-upgrade
and post-upgrade manifest file for a certain component, a backup file for it will not be written.</p><h2 id=how-it-works>How it works</h2><p><code>kubeadm upgrade apply</code> does the following:</p><ul><li>Checks that your cluster is in an upgradeable state:<ul><li>The API server is reachable</li><li>All nodes are in the <code>Ready</code> state</li><li>The control plane is healthy</li></ul></li><li>Enforces the version skew policies.</li><li>Makes sure the control plane images are available or available to pull to the machine.</li><li>Generates replacements and/or uses user supplied overwrites if component configs require version upgrades.</li><li>Upgrades the control plane components or rollbacks if any of them fails to come up.</li><li>Applies the new <code>kube-dns</code> and <code>kube-proxy</code> manifests and makes sure that all necessary RBAC rules are created.</li><li>Creates new certificate and key files of the API server and backs up old files if they're about to expire in 180 days.</li></ul><p><code>kubeadm upgrade node</code> does the following on additional control plane nodes:</p><ul><li>Fetches the kubeadm <code>ClusterConfiguration</code> from the cluster.</li><li>Optionally backups the kube-apiserver certificate.</li><li>Upgrades the static Pod manifests for the control plane components.</li><li>Upgrades the kubelet configuration for this node.</li></ul><p><code>kubeadm upgrade node</code> does the following on worker nodes:</p><ul><li>Fetches the kubeadm <code>ClusterConfiguration</code> from the cluster.</li><li>Upgrades the kubelet configuration for this node.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-9133578f1e75663bb031e5a377ca896d>3 - Adding Windows nodes</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [beta]</code></div><p>You can use Kubernetes to run a mixture of Linux and Windows nodes, so you can mix Pods that run on Linux on with Pods that run on Windows. This page shows how to register Windows nodes to your cluster.</p><h2 id=before-you-begin>Before you begin</h2>Your Kubernetes server must be at or later than version 1.17.
To check the version, enter <code>kubectl version</code>.<ul><li><p>Obtain a <a href=https://www.microsoft.com/en-us/cloud-platform/windows-server-pricing>Windows Server 2019 license</a>
(or higher) in order to configure the Windows node that hosts Windows containers.
If you are using VXLAN/Overlay networking you must have also have <a href=https://support.microsoft.com/help/4489899>KB4489899</a> installed.</p></li><li><p>A Linux-based Kubernetes kubeadm cluster in which you have access to the control plane (see <a href=/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/>Creating a single control-plane cluster with kubeadm</a>).</p></li></ul><h2 id=objectives>Objectives</h2><ul><li>Register a Windows node to the cluster</li><li>Configure networking so Pods and Services on Linux and Windows can communicate with each other</li></ul><h2 id=getting-started-adding-a-windows-node-to-your-cluster>Getting Started: Adding a Windows Node to Your Cluster</h2><h3 id=networking-configuration>Networking Configuration</h3><p>Once you have a Linux-based Kubernetes control-plane node you are ready to choose a networking solution. This guide illustrates using Flannel in VXLAN mode for simplicity.</p><h4 id=configuring-flannel>Configuring Flannel</h4><ol><li><p>Prepare Kubernetes control plane for Flannel</p><p>Some minor preparation is recommended on the Kubernetes control plane in our cluster. It is recommended to enable bridged IPv4 traffic to iptables chains when using Flannel. The following command must be run on all Linux nodes:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo sysctl net.bridge.bridge-nf-call-iptables<span style=color:#666>=</span><span style=color:#666>1</span>
</code></pre></div></li><li><p>Download & configure Flannel for Linux</p><p>Download the most recent Flannel manifest:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre></div><p>Modify the <code>net-conf.json</code> section of the flannel manifest in order to set the VNI to 4096 and the Port to 4789. It should look as follows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span>net-conf.json:</span> <span>|</span>
    {
      <span style=color:green;font-weight:700>&#34;Network&#34;</span>: <span style=color:#b44>&#34;10.244.0.0/16&#34;</span>,
      <span style=color:green;font-weight:700>&#34;Backend&#34;</span>: {
        <span style=color:green;font-weight:700>&#34;Type&#34;</span>: <span style=color:#b44>&#34;vxlan&#34;</span>,
        <span style=color:green;font-weight:700>&#34;VNI&#34;</span>: <span style=color:#666>4096</span>,
        <span style=color:green;font-weight:700>&#34;Port&#34;</span>: <span style=color:#666>4789</span>
      }
    }
</code></pre></div><blockquote class="note callout"><div><strong>Note:</strong> The VNI must be set to 4096 and port 4789 for Flannel on Linux to interoperate with Flannel on Windows. See the <a href=https://github.com/coreos/flannel/blob/master/Documentation/backends.md#vxlan>VXLAN documentation</a>.
for an explanation of these fields.</div></blockquote><blockquote class="note callout"><div><strong>Note:</strong> To use L2Bridge/Host-gateway mode instead change the value of <code>Type</code> to <code>"host-gw"</code> and omit <code>VNI</code> and <code>Port</code>.</div></blockquote></li><li><p>Apply the Flannel manifest and validate</p><p>Let's apply the Flannel configuration:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f kube-flannel.yml
</code></pre></div><p>After a few minutes, you should see all the pods as running if the Flannel pod network was deployed.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pods -n kube-system
</code></pre></div><p>The output should include the Linux flannel DaemonSet as running:</p><pre><code>NAMESPACE     NAME                                      READY        STATUS    RESTARTS   AGE
...
kube-system   kube-flannel-ds-54954                     1/1          Running   0          1m
</code></pre></li><li><p>Add Windows Flannel and kube-proxy DaemonSets</p><p>Now you can add Windows-compatible versions of Flannel and kube-proxy. In order
to ensure that you get a compatible version of kube-proxy, you'll need to substitute
the tag of the image. The following example shows usage for Kubernetes v1.20.15,
but you should adjust the version for your own deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -L https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/kube-proxy.yml | sed <span style=color:#b44>&#39;s/VERSION/v1.20.15/g&#39;</span> | kubectl apply -f -
kubectl apply -f https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml
</code></pre></div><blockquote class="note callout"><div><strong>Note:</strong> If you're using host-gateway use <a href=https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-host-gw.yml>https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-host-gw.yml</a> instead</div></blockquote><blockquote class="note callout"><div><strong>Note:</strong><p>If you're using a different interface rather than Ethernet (i.e. "Ethernet0 2") on the Windows nodes, you have to modify the line:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>wins <span style=color:#a2f>cli </span><span style=color:#a2f;font-weight:700>process</span> run --path /k/flannel/setup.exe --args <span style=color:#b44>&#34;--mode=overlay --interface=Ethernet&#34;</span>
</code></pre></div><p>in the <code>flannel-host-gw.yml</code> or <code>flannel-overlay.yml</code> file and specify your interface accordingly.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#080;font-style:italic># Example</span>
curl -L https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/flannel-overlay.yml | sed <span style=color:#b44>&#39;s/Ethernet/Ethernet0 2/g&#39;</span> | kubectl apply -f -
</code></pre></div></div></blockquote></li></ol><h3 id=joining-a-windows-worker-node>Joining a Windows worker node</h3><blockquote class="note callout"><div><strong>Note:</strong> All code snippets in Windows sections are to be run in a PowerShell environment
with elevated permissions (Administrator) on the Windows worker node.</div></blockquote><ul class="nav nav-tabs" id=tab-windows-kubeadm-runtime-installation role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#tab-windows-kubeadm-runtime-installation-0 role=tab aria-controls=tab-windows-kubeadm-runtime-installation-0 aria-selected=true>Docker EE</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#tab-windows-kubeadm-runtime-installation-1 role=tab aria-controls=tab-windows-kubeadm-runtime-installation-1>CRI-containerD</a></li></ul><div class=tab-content id=tab-windows-kubeadm-runtime-installation><div id=tab-windows-kubeadm-runtime-installation-0 class="tab-pane show active" role=tabpanel aria-labelledby=tab-windows-kubeadm-runtime-installation-0><p><h4 id=install-docker-ee>Install Docker EE</h4><p>Install the <code>Containers</code> feature</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#a2f>Install-WindowsFeature</span> -Name containers
</code></pre></div><p>Install Docker
Instructions to do so are available at <a href=https://hub.docker.com/editions/enterprise/docker-ee-server-windows>Install Docker Engine - Enterprise on Windows Servers</a>.</p><h4 id=install-wins-kubelet-and-kubeadm>Install wins, kubelet, and kubeadm</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell>curl.exe -LO https<span>:</span>//github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/PrepareNode.ps1
.\PrepareNode.ps1 -KubernetesVersion v1.20.15
</code></pre></div><h4 id=run-kubeadm-to-join-the-node>Run <code>kubeadm</code> to join the node</h4><p>Use the command that was given to you when you ran <code>kubeadm init</code> on a control plane host.
If you no longer have this command, or the token has expired, you can run <code>kubeadm token create --print-join-command</code>
(on a control plane host) to generate a new token and join command.</p></div><div id=tab-windows-kubeadm-runtime-installation-1 class=tab-pane role=tabpanel aria-labelledby=tab-windows-kubeadm-runtime-installation-1><p><h4 id=install-containerd>Install containerD</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>curl.exe -LO https<span>:</span>//github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/<span style=color:#a2f>Install-Containerd</span>.ps1
.\<span style=color:#a2f>Install-Containerd</span>.ps1
</code></pre></div><blockquote class="note callout"><div><strong>Note:</strong><p>To install a specific version of containerD specify the version with -ContainerDVersion.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#080;font-style:italic># Example</span>
.\<span style=color:#a2f>Install-Containerd</span>.ps1 -ContainerDVersion v1.4.1
</code></pre></div></div></blockquote><blockquote class="note callout"><div><strong>Note:</strong><p>If you're using a different interface rather than Ethernet (i.e. "Ethernet0 2") on the Windows nodes, specify the name with <code>-netAdapterName</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#080;font-style:italic># Example</span>
.\<span style=color:#a2f>Install-Containerd</span>.ps1 -netAdapterName <span style=color:#b44>&#34;Ethernet0 2&#34;</span>
</code></pre></div></div></blockquote><h4 id=install-wins-kubelet-and-kubeadm>Install wins, kubelet, and kubeadm</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell>curl.exe -LO https<span>:</span>//github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/PrepareNode.ps1
.\PrepareNode.ps1 -KubernetesVersion v1.20.15 -ContainerRuntime containerD
</code></pre></div><h4 id=run-kubeadm-to-join-the-node>Run <code>kubeadm</code> to join the node</h4><p>Use the command that was given to you when you ran <code>kubeadm init</code> on a control plane host.
If you no longer have this command, or the token has expired, you can run <code>kubeadm token create --print-join-command</code>
(on a control plane host) to generate a new token and join command.</p><blockquote class="note callout"><div><strong>Note:</strong> If using <strong>CRI-containerD</strong> add <code>--cri-socket "npipe:////./pipe/containerd-containerd"</code> to the kubeadm call</div></blockquote></div></div><h3 id=verifying-your-installation>Verifying your installation</h3><p>You should now be able to view the Windows node in your cluster by running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get nodes -o wide
</code></pre></div><p>If your new node is in the <code>NotReady</code> state it is likely because the flannel image is still downloading.
You can check the progress as before by checking on the flannel pods in the <code>kube-system</code> namespace:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl -n kube-system get pods -l <span style=color:#b8860b>app</span><span style=color:#666>=</span>flannel
</code></pre></div><p>Once the flannel Pod is running, your node should enter the <code>Ready</code> state and then be available to handle workloads.</p><h2 id=what-s-next>What's next</h2><ul><li><a href=/docs/tasks/administer-cluster/kubeadm/upgrading-windows-nodes>Upgrading Windows kubeadm nodes</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e805c7d8d4ad6195cb82dbbc843bfc29>4 - Upgrading Windows nodes</h1><div style=margin-top:10px;margin-bottom:10px><b>FEATURE STATE:</b> <code>Kubernetes v1.18 [beta]</code></div><p>This page explains how to upgrade a Windows node <a href=/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes>created with kubeadm</a>.</p><h2 id=before-you-begin>Before you begin</h2><p><p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href=/docs/tasks/tools/#minikube>minikube</a>
or you can use one of these Kubernetes playgrounds:</p><ul><li><a href=https://www.katacoda.com/courses/kubernetes/playground>Katacoda</a></li><li><a href=http://labs.play-with-k8s.com/>Play with Kubernetes</a></li></ul>Your Kubernetes server must be at or later than version 1.17.
To check the version, enter <code>kubectl version</code>.</p><ul><li>Familiarize yourself with <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade>the process for upgrading the rest of your kubeadm
cluster</a>. You will want to
upgrade the control plane nodes before upgrading your Windows nodes.</li></ul><h2 id=upgrading-worker-nodes>Upgrading worker nodes</h2><h3 id=upgrade-kubeadm>Upgrade kubeadm</h3><ol><li><p>From the Windows node, upgrade kubeadm:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#080;font-style:italic># replace v1.20.15 with your desired version</span>
curl.exe -Lo C:\k\kubeadm.exe https<span>:</span>//dl.k8s.io/v1.20.15/bin/windows/amd64/kubeadm.exe
</code></pre></div></li></ol><h3 id=drain-the-node>Drain the node</h3><ol><li><p>From a machine with access to the Kubernetes API,
prepare the node for maintenance by marking it unschedulable and evicting the workloads:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node you are draining</span>
kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</code></pre></div><p>You should see output similar to this:</p><pre><code>node/ip-172-31-85-18 cordoned
node/ip-172-31-85-18 drained
</code></pre></li></ol><h3 id=upgrade-the-kubelet-configuration>Upgrade the kubelet configuration</h3><ol><li><p>From the Windows node, call the following command to sync new kubelet configuration:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>kubeadm upgrade node
</code></pre></div></li></ol><h3 id=upgrade-kubelet>Upgrade kubelet</h3><ol><li><p>From the Windows node, upgrade and restart the kubelet:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#a2f>stop-service</span> kubelet
curl.exe -Lo C:\k\kubelet.exe https<span>:</span>//dl.k8s.io/v1.20.15/bin/windows/amd64/kubelet.exe
<span style=color:#a2f>restart-service</span> kubelet
</code></pre></div></li></ol><h3 id=uncordon-the-node>Uncordon the node</h3><ol><li><p>From a machine with access to the Kubernetes API,
bring the node back online by marking it schedulable:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># replace &lt;node-to-drain&gt; with the name of your node</span>
kubectl uncordon &lt;node-to-drain&gt;
</code></pre></div></li></ol><h3 id=upgrade-kube-proxy>Upgrade kube-proxy</h3><ol><li><p>From a machine with access to the Kubernetes API, run the following,
again replacing v1.20.15 with your desired version:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -L https://github.com/kubernetes-sigs/sig-windows-tools/releases/latest/download/kube-proxy.yml | sed <span style=color:#b44>&#39;s/VERSION/v1.20.15/g&#39;</span> | kubectl apply -f -
</code></pre></div></li></ol></div></main></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/docs/home/>Home</a>
<a class=text-white href=/blog/>Blog</a>
<a class=text-white href=/training/>Training</a>
<a class=text-white href=/partners/>Partners</a>
<a class=text-white href=/community/>Community</a>
<a class=text-white href=/case-studies/>Case Studies</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank href=https://discuss.kubernetes.io><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/kubernetesio><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar><a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io"><i class="fas fa-calendar-alt"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small><br><small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/popper-1.14.3.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=/js/bootstrap-4.3.1.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script><script src=/js/main.min.40616251a9b6e4b689e7769be0340661efa4d7ebb73f957404e963e135b4ed52.js integrity="sha256-QGFiUam25LaJ53ab4DQGYe+k1+u3P5V0BOlj4TW07VI=" crossorigin=anonymous></script></body></html>